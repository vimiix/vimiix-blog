---
title: 'rsync服务器配置文件参数备忘'
date: 2017-10-30 13:12:48
categories: Linux
tags: [Linux, rsync]
---

最近工作中用到了 rsync 服务器，对于 rsync 服务器的配置来说，不是很复杂，网上有很多介绍。rsync 的配置文件是最重要的一部分。有很多参数需要了解一下，所以今天记录整理一下，方便以后自己查看。

## 基本介绍

> Rsync（remote synchronize）是一个远程数据同步工具，可通过 LAN/WAN 快速同步多台主机间的文件。Rsync 使用所谓的“Rsync 算法”来使本地和远 程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。

rsync 的配置文件是由一个或多个模块结构组成。一个模块定义是以方括弧中的模块名开始，直到下一个模块定义开始或者文件结束。

模块中包含格式为`name = value`的参数定义。每个模块其实就对应需要备份的一个目录树，比方说在实际环境中，有三个目录树需要备份：/www/、/home/web_user1/和/home/web_user2/，那么就需要在配置文件中定义三个模块，分别对应三个目录树。

配置文件是行为单位的，也就是说每个新行都表示一个新的注释、模块定义或者参数赋值。以`#`开始的行表示注释，以""结束的行表示下面一行是该行的继续。参数赋值中等号后可能是一个大小写不敏感的字符串、一个以`trure/false`或者`yes/no`表示的布尔值。

## 全局参数

在文件中`[modlue]`之前的所有参数都是全局参数，当然也可以在全局参数部分定义模块参数，这时候该参数的值就是所有模块的默认值。

### `motd file`

指定一个消息文件，当客户连接服务器时该文件的内容显示给客户，默认是没有 motd 文件的。该文件有无都不影响 rsync 的正常使用。

### `log file`

指定 rsync 的日志文件，而不将日志发送给`syslog`。

### `pid file`

指定 rsync 的 pid 文件。

### `syslog facility`

指定 rsync 发送日志消息给 syslog 时的消息级别，常见的消息级别是：`uth`, `authpriv`, `cron`, `daemon`, `ftp`, `kern`, `lpr`, `mail`, `news`, `security`, `sys-log`, `user`, `uucp`, `local0`, `local1`, `local2`, `local3`,`local4`, `local5`, `local6`和`local7`。

默认值是`daemon`。

## 模块参数

在全局参数之后就需要定义一个或多个模块了，模块中可以定义以下参数：

### `comment`

给模块指定一个描述，该描述连同模块名在客户连接得到模块列表时显示给客户。默认没有描述定义。

### `path`

指定该模块的供备份的目录树路径，该参数是必须指定的。

### `use chroot`

如果`use chroot`指定为`true`，那么 rsync 在传输文件以前首先 chroot 到 path 参数所指定的目录下。这样做的原因是实现额外的安全防护，但是缺点是需要 root 权限，并且不能备份指向外部的符号连接所指向的目录文件。默认情况下`chroot`值为`true`。

### `max connections`

指定该模块的最大并发连接数量以保护服务器，超过限制的连接请求将被告知随后再试。默认值是`0`，也就是没有限制。

### `lock file`

指定支持 max connections 参数的锁文件，默认值是`/var/run/rsyncd.lock`。

### `read only`

该选项设定是否允许客户上载文件。如果为`true`那么任何上载请求都会失败，如果为`false`并且服务器目录读写权限允许那么上载是允许的。默认值为`true`。

### `list`

该选项设定当客户请求可以使用的模块列表时，该模块是否应该被列出。如果设置该选项为`false`，可以创建隐藏的模块。默认值是`true`。

### `uid`

该选项指定当该模块传输文件时守护进程应该具有的 uid，配合 gid 选项使用可以确定哪些可以访问怎么样的文件权限，默认值是`nobody`。

### `gid`

该选项指定当该模块传输文件时守护进程应该具有的 gid。默认值为`nobody`。

### `exclude`

用来指定多个由空格隔开的多个模式列表，并将其添加到`exclude`列表中。这等同于在客户端命令中使用–exclude 来指定模式，不过配置文件中指定的 exclude 模式不会传递给客户端，而仅仅应用于服务器。一个模块只能指定一个 exclude 选项，但是可以在模式前面使用"-"和"+"来指定是 exclude 还是 include。

但是需要注意的一点是该选项有一定的安全性问题，客户很有可能绕过 exclude 列表，如果希望确保特定的文件不能被访问，那就最好结合`uid/gid`选项一起使用。

### `exclude from`

指定一个包含 exclude 模式的定义的文件名，服务器从该文件中读取 exclude 列表定义。

### `include`

用来指定多个由空格隔开的多个 rsync 并应该 exlude 的模式列表。这等同于在客户端命令中使用–`include`来指定模式，结合`include`和`exclude`可以定义复杂的 exclude/include 规则 。一个模块只能指定一个`include`选项，但是可以在模式前面使用"-"和"+"来指定是 exclude 还是 include。

### `include from`

指定一个包含`include`模式的定义的文件名，服务器从该文件中读取 include 列表定义。

### `auth users`

该选项指定由空格或逗号分隔的用户名列表，只有这些用户才允许连接该模块。这里的用户和系统用户没有任何关系。如果`auth users`被设置，那么客户端发出对该模块的连接请求以后会被 rsync 请求 challenged 进行验证身份,这里使用的 challenge/response 认证协议。用户的名和密码以明文方式存放在`secrets file`选项指定的文件中。默认情况下无需密码就可以连接模块(也就是匿名方式)。

### `secrets file`

该选项指定一个包含定义用户名:密码对的文件。只有在`auth users`被定义时，该文件才有作用。文件每行包含一个`username:passwd`对。一般来说密码最好不要超过 8 个字符。没有默认的 secures file 名，需要限式指定一个。(例如：`/etc/rsyncd.secrets`)

### `strict modes`

该选项指定是否监测密码文件的权限，如果该选项值为`true`那么密码文件只能被 rsync 服务器运行身份的用户访问，其他任何用户不可以访问该文件。默认值为`true`。

### `hosts allow`

该选项指定哪些 IP 的客户允许连接该模块。客户模式定义可以是以下形式：

- `xxx.xxx.xxx.xxx`，客户主机只有完全匹配该 IP 才允许访问。例如：`192.167.0.1`

- `a.b.c.d/n`，属于该网络的客户都允许连接该模块。例如：`192.168.0.0/24`

- `a.b.c.d/e.f.g.h`，属于该网络的客户都允许连接该模块。例如：`192.168.0.0/255.255.255.0`

- 一个主机名，客户主机只有拥有该主机名才允许访问，例如：`backup.example.com`。

- `*.example.com`，所有属于该域的主机都允许。

默认是允许所有主机连接。

### `hosts deny`

指定不允许连接 rsync 服务器的机器，可以使用`hosts allow`的定义方式来进行定义。默认是没有`hosts deny`定义。

### `ignore errors`

指定 rsyncd 在判断是否运行传输时的删除操作时忽略 server 上的 IP 错误，一般来说 rsync 在出现 IO 错误时将将跳过`–delete`操作，以防止因为暂时的资源不足或其它 IO 错误导致的严重问题。

### `ignore nonreadable`

指定 rysnc 服务器完全忽略那些用户没有访问权限的文件。这对于在需要备份的目录中有些文件是不应该被备份者得到的情况是有意义的。

### `transfer logging`

使 rsync 服务器使用 ftp 格式的文件来记录下载和上载操作在自己单独的日志中。

### `log format`

通过该选项用户在使用`transfer logging`可以自己定制日志文件的字段。其格式是一个包含格式定义符的字符串，可以使用的格式定义符如下所示：

- `%h` 远程主机名
- `%a` 远程 IP 地址
- `%l` 文件长度字符数
- `%p` 该次 rsync 会话的进程 id
- `%o` 操作类型："send"或"recv"
- `%f` 文件名
- `%P` 模块路径
- `%m` 模块名
- `%t` 当前时间
- `%u` 认证的用户名(匿名时是 null)
- `%b` 实际传输的字节数
- `%c` 当发送文件时，该字段记录该文件的校验码

默认 log 格式为：`%o %h [%a] %m (%u) %f %l`，一般来说,在每行的头上会添加`%t [%p]`。在源代码中同时发布有一个叫`rsyncstats`的 perl 脚本程序来统计这种格式的日志文件。

### `timeout`

通过该选项可以覆盖客户指定的 IP 超时时间。通过该选项可以确保 rsync 服务器不会永远等待一个崩溃的客户端。超时单位为秒钟，0 表示没有超时定义，这也是默认值。对于匿名 rsync 服务器来说，一个理想的数字是`600`。

### `refuse options`

通过该选项可以定义一些不允许客户对该模块使用的命令参数列表。这里必须使用命令全名，而不能是简称。但发生拒绝某个命令的情况时服务器将报告错误信息然后退出。如果要防止使用压缩，应该是:`dont compress = *`。

### `dont compress`

用来指定那些不进行压缩处理再传输的文件.

默认值是`*.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz`。
